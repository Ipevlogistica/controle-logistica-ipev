<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Consumo Total por Motorista • IPEV</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.44.4/dist/umd/supabase.js"></script>
</head>
<body class="bg-gray-100 text-sm">
  <div class="p-4">
    <div class="flex items-center justify-between mb-4">
      <h1 class="text-xl font-bold">Consumo Total por Motorista</h1>
      <a href="index.html">
        <button class="bg-blue-800 text-white px-4 py-2 rounded-md font-semibold">⬅ Voltar</button>
      </a>
    </div>

    <!-- Filtros de período (Mês/Ano) -->
    <div class="bg-white border border-gray-300 rounded-md p-3 mb-4 grid grid-cols-1 md:grid-cols-4 gap-3">
      <div>
        <label class="block text-xs text-gray-600 mb-1">Mês</label>
        <select id="selMes" class="w-full border rounded px-2 py-1">
          <option value="1">Janeiro</option>
          <option value="2">Fevereiro</option>
          <option value="3">Março</option>
          <option value="4">Abril</option>
          <option value="5">Maio</option>
          <option value="6">Junho</option>
          <option value="7">Julho</option>
          <option value="8">Agosto</option>
          <option value="9">Setembro</option>
          <option value="10">Outubro</option>
          <option value="11">Novembro</option>
          <option value="12">Dezembro</option>
        </select>
      </div>
      <div>
        <label class="block text-xs text-gray-600 mb-1">Ano</label>
        <select id="selAno" class="w-full border rounded px-2 py-1"></select>
      </div>
      <div class="md:col-span-2 flex items-end gap-2">
        <button id="btnAtualizar" class="bg-blue-700 text-white px-4 py-2 rounded-md font-semibold">Atualizar</button>
        <span class="text-xs text-gray-600">As colunas (Dia 1..N) são geradas conforme há registros no Supabase para o mês/ano selecionados.</span>
        <span id="statusMsg" class="text-xs ml-2"></span>
      </div>
    </div>

    <!-- Tabela dinâmica: Motorista (Placa) + Recargas + Dias do mês -->
    <div class="overflow-x-auto">
      <table class="min-w-full bg-white border border-gray-300" id="tabela">
        <thead id="thead" class="bg-blue-100"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

<script>
  // ============================
  // CONFIGURAÇÃO SUPABASE
  // ============================
  const SUPABASE_URL = 'https://ilsbyrvnrkutwynujfhs.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlsc2J5cnZucmt1dHd5bnVqZmhzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzNDAwNDEsImV4cCI6MjA2OTkxNjA0MX0.o56R-bf1Nt3PiqMZbG_ghEPYZzrPnEU-jCdYKkjylTQ';
  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  // Campos no banco
  const DATA_FIELDS = ['data', 'Data', 'created_at'];
  const MOTORISTA_FIELDS = ['motorista', 'Motorista', 'nome_motorista'];
  const PLACA_FIELDS = ['placa', 'Placa'];
  const VALOR_DIA_FIELDS = ['valor_total']; // exclusivo

  const el = (id) => document.getElementById(id);

  function daysInMonth(year, month1to12){
    return new Date(year, month1to12, 0).getDate();
  }
  function iso(d){
    try { return new Date(d).toISOString().slice(0,10); } catch { return ''; }
  }
  function pickFirst(row, fields){
    for (let i=0; i<fields.length; i++){
      const f = fields[i];
      if (row && row[f] != null) return row[f];
    }
    return undefined;
  }
  function toNum(v){
    const n = Number(v); return Number.isFinite(n) ? n : 0;
  }
  function sumKnownFields(row, fields){
    let acc = 0;
    for (let i=0; i<fields.length; i++) acc += toNum(row[fields[i]]);
    return acc;
  }

  // ------- Carregar motoristas (lista base de linhas)
  async function getMotoristas(){
    const result = await supa.from('motoristas').select('nome,placa');
    if (result.error){ console.error(result.error); return []; }
    const data = result.data || [];
    return data.map(m => ({
      nome: m.nome || '—',
      placa: m.placa || ''
    }));
  }

  // ------- Buscar registros do mês/ano e indexar por motorista + dia
  async function getRegistrosMesAno(ano, mes){
    const primeiroDia = `${ano}-${String(mes).padStart(2,'0')}-01`;
    const ultimoDia = `${ano}-${String(mes).padStart(2,'0')}-${String(daysInMonth(ano, mes)).padStart(2,'0')}`;

    const result = await supa
      .from('controle_diario')
      .select('motorista,data,valor_total')
      .gte('data', primeiroDia)
      .lte('data', ultimoDia);

    if (result.error){ console.error(result.error); return new Map(); }
    const rows = result.data || [];

    const mapa = new Map(); // key: nomeMotorista -> { dia: valor_total }
    for (let i=0; i<rows.length; i++){
      const r = rows[i];
      const nome = String(pickFirst(r, MOTORISTA_FIELDS) || '—');
      const dataIso = iso(pickFirst(r, DATA_FIELDS));
      const dia = dataIso ? Number(dataIso.slice(8,10)) : null;
      if (!dia) continue;
      const valor = sumKnownFields(r, VALOR_DIA_FIELDS);
      if (!mapa.has(nome)) mapa.set(nome, {});
      const obj = mapa.get(nome);
      obj[dia] = (obj[dia] || 0) + valor;
    }
    return mapa;
  }

  function desenharCabecalho(qtdDias){
    const ths = [];
    ths.push('<th class="border px-2 py-1">Motorista (Placa)</th>');
    ths.push('<th class="border px-2 py-1">Recarga (R$)</th>');
    ths.push('<th class="border px-2 py-1">Adicional (R$)</th>');
    for (let d=1; d<=qtdDias; d++){
      ths.push(`<th class="border px-2 py-1">Dia ${d}</th>`);
    }
    el('thead').innerHTML = `<tr>${ths.join('')}</tr>`;
  }

  function desenharLinhas(motoristas, mapaValores, qtdDias){
    const linhas = [];
    for (let i=0; i<motoristas.length; i++){
      const m = motoristas[i];
      const nomePlaca = `${m.nome}${m.placa ? ' ('+m.placa+')' : ''}`;
      const valores = mapaValores.get(m.nome) || {};
      const tds = [];
      tds.push(`<td class="border px-2 py-1">${nomePlaca}</td>`);
      tds.push(`<td class="border px-2 py-1"><input type="number" step="0.01" class="w-24 text-right border rounded recarga" value="250.00" data-motorista="${m.nome}"></td>`);
      tds.push(`<td class="border px-2 py-1"><input type="number" step="0.01" class="w-24 text-right border rounded adicional" data-motorista="${m.nome}" placeholder="0.00"></td>`);
      for (let d=1; d<=qtdDias; d++){
        const v = valores[d];
        tds.push(`<td class="border px-2 py-1 text-right">${(v!=null && v!==0) ? Number(v).toFixed(2) : '—'}</td>`);
      }
      linhas.push(`<tr>${tds.join('')}</tr>`);
    }
    el('tbody').innerHTML = linhas.join('');
  }

  async function atualizarTabela(){
    const mes = Number(el('selMes').value) || (new Date().getMonth()+1);
    const ano = Number(el('selAno').value) || (new Date().getFullYear());
    const qtdDias = daysInMonth(ano, mes);

    desenharCabecalho(qtdDias);

    const status = el('statusMsg');
    if (status) status.textContent = '';

    try {
      const resultados = await Promise.all([
        getMotoristas(),
        getRegistrosMesAno(ano, mes)
      ]);
      const motoristas = resultados[0];
      const mapa = resultados[1];
      desenharLinhas(motoristas, mapa, qtdDias);
      if (status){ status.textContent = `Carregado ${motoristas.length} motorista(s)`; status.className = 'text-xs ml-2 text-gray-600'; }
    } catch (e){
      console.error('Erro ao atualizar tabela:', e);
      if (status){ status.textContent = 'Falha ao carregar dados'; status.className = 'text-xs ml-2 text-red-600'; }
      desenharLinhas([], new Map(), qtdDias);
    }
  }

  document.addEventListener('DOMContentLoaded', function(){
    const anoAtual = new Date().getFullYear();
    const anos = [];
    for (let a = anoAtual - 3; a <= anoAtual + 1; a++) anos.push(a);
    el('selAno').innerHTML = anos.map(function(a){ return `<option value="${a}">${a}</option>`; }).join('');
    el('selMes').value = String(new Date().getMonth()+1);
    el('selAno').value = String(anoAtual);
    el('btnAtualizar').addEventListener('click', atualizarTabela);
    atualizarTabela();
  });
</script>
</body>
</html>
