<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>√Årea do Gestor ‚Äî IPEV</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root{ --azul:#0ea5b7; --azul2:#12849a; --cinza:#6b7280; --branco:#fff; --texto:#0b2340; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:Arial,Helvetica,sans-serif; background:#f3f7f8; color:var(--texto); }
    .hero{ position:relative; min-height:240px; display:flex; align-items:flex-end;
      background-image: linear-gradient(rgba(0,0,0,.35), rgba(0,0,0,.35)), url('frota-bg.jpg');
      background-size:cover; background-position:center; box-shadow:inset 0 -30px 30px rgba(0,0,0,.18); }
    .wrap{ width:100%; max-width:1100px; margin:0 auto; padding:28px 18px 32px; display:flex; justify-content:space-between; align-items:flex-end; }
    .titulo{ color:#fff; margin:0; font-size:30px; text-shadow:0 2px 6px rgba(0,0,0,.35); }
    .sub{ color:#eaf7fb; margin:6px 0 0; font-size:14px; }
    .chip-user{ background:rgba(255,255,255,.95); color:#123; padding:9px 14px; border-radius:999px; font-size:13px; box-shadow:0 2px 10px rgba(0,0,0,.2); white-space:nowrap; }
    .topbar{ position:fixed; top:10px; right:10px; z-index:10; display:flex; gap:8px; }
    .btn{ background:var(--azul); color:#fff; border:0; border-radius:8px; padding:10px 14px; cursor:pointer; }
    .btn:hover{ background:var(--azul2); }
    .btn-secondary{ background:var(--cinza); }
    .btn-secondary:hover{ background:#4b5563; }
    .main{ max-width:1100px; margin:22px auto 34px; padding:0 18px; }
    .card{ background:#fff; border-radius:14px; box-shadow:0 10px 24px rgba(16,24,40,.08); padding:18px; margin-bottom:16px; }
    .card h3{ margin:0 0 12px; font-size:18px; color:#0f172a; }
    .toolbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:10px; }
    .input{ padding:10px 12px; border:1px solid #d1d5db; border-radius:8px; min-width:240px; background:#fff; }
    .table{ width:100%; border-collapse:collapse; }
    .table th,.table td{ padding:10px 12px; border-bottom:1px solid #eef2f7; }
    .table th{ text-align:left; font-size:13px; color:#374151; cursor:pointer; user-select:none; }
    .table td{ font-size:14px; color:#111827; }
    .muted{ color:#6b7280; font-size:12px; }
    .right{ text-align:right; }
    .danger{ background:#dc2626; }
    .danger:hover{ background:#b91c1c; }
    .pagination{ display:flex; gap:8px; align-items:center; justify-content:flex-end; margin-top:10px; }
    .empty{ padding:16px; color:#6b7280; }

    /* === PATCH: dialog/backdrop + fallback === */
    dialog::backdrop { background: rgba(0,0,0,.45); }
    dialog[open] { display: block; }
  </style>
</head>
<body>

  <div class="hero">
    <div class="wrap">
      <div>
        <h1 class="titulo">√Årea do Gestor</h1>
        <p class="sub">Gest√£o de usu√°rios e permiss√µes do sistema</p>
      </div>
      <div class="chip-user" id="chipUser">Logado:</div>
    </div>
  </div>

  <div class="topbar">
    <button class="btn-secondary btn" id="btnSairMenu">‚Ü©Ô∏è Menu</button>
    <button class="btn-secondary btn" id="btnLogout">üö™ Logout</button>
  </div>

  <div class="main">
    <div class="card">
      <div class="toolbar">
        <button class="btn" id="btnOpenCreate">üë® Cadastrar usu√°rio</button>
        <button class="btn" id="btnOpenReset">üîë Redefinir senha</button>
        <!-- NOVO: bot√£o que abre a listagem -->
        <button class="btn" id="btnOpenList">üë• Listar usu√°rios</button>
        <!-- NOVO: bot√£o Permiss√µes -->
        <button class="btn" id="btnOpenPerm">üõ°Ô∏è Permiss√µes</button>
        <span class="muted">Em breve: pap√©is, permiss√µes, auditoria‚Ä¶</span>
      </div>
    </div>

    <!-- Listagem fica escondida at√© clicar em "Listar usu√°rios" -->
    <div class="card" id="cardList" style="display:none;">
      <h3 style="display:flex;justify-content:space-between;align-items:center;">
        Usu√°rios
        <button class="btn-secondary btn" id="btnCloseList" title="Fechar">Fechar</button>
      </h3>

      <div class="toolbar">
        <input id="busca" class="input" placeholder="Buscar na p√°gina (nome ou e-mail)‚Ä¶">
        <select id="perPage" class="input" style="min-width:120px">
          <option value="10">10 por p√°gina</option>
          <option value="20">20 por p√°gina</option>
          <option value="50">50 por p√°gina</option>
        </select>
        <button id="btnRefresh" class="btn">Atualizar</button>
      </div>

      <div style="overflow:auto;">
        <table class="table" id="tbl">
          <thead>
            <tr>
              <th data-sort="display_name">Nome</th>
              <th data-sort="email">E-mail</th>
              <th data-sort="created_at">Criado em</th>
              <th data-sort="last_sign_in_at">√öltimo login</th>
              <th class="right">A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="pagination">
        <span id="pageInfo" class="muted"></span>
        <button class="btn-secondary btn" id="prev">‚óÄ</button>
        <button class="btn-secondary btn" id="next">‚ñ∂</button>
      </div>
    </div>
  </div>

  <!-- Modal Cadastrar -->
  <dialog id="dlgCreate" style="border:0; border-radius:12px; padding:0; width:95%; max-width:560px;">
    <form method="dialog" style="padding:18px">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
        <h3 style="margin:0">Cadastrar usu√°rio</h3>
        <button class="btn-secondary btn" value="cancel">Fechar</button>
      </div>
      <label>Nome completo
        <input id="c_nome" class="input" style="width:100%; margin-top:6px">
      </label><br><br>
      <label>Usu√°rio
        <input id="c_user" class="input" style="width:100%; margin-top:6px">
      </label><br><br>
      <label>E-mail
        <input id="c_email" class="input" style="width:100%; margin-top:6px">
      </label><br><br>
      <label>Senha inicial
        <input id="c_senha" type="password" class="input" style="width:100%; margin-top:6px">
      </label>
      <p id="c_erro" class="muted" style="color:#dc2626; margin-top:8px"></p>
      <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:10px">
        <button class="btn-secondary btn" value="cancel">Cancelar</button>
        <button id="c_salvar" type="button" class="btn">Salvar</button>
      </div>
    </form>
  </dialog>

  <!-- Modal Reset -->
  <dialog id="dlgReset" style="border:0; border-radius:12px; padding:0; width:95%; max-width:520px;">
    <form method="dialog" style="padding:18px">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
        <h3 style="margin:0">Redefinir senha</h3>
        <button class="btn-secondary btn" value="cancel">Fechar</button>
      </div>
      <label>E-mail do usu√°rio
        <input id="r_email" class="input" style="width:100%; margin-top:6px">
      </label><br><br>
      <label>Nova senha
        <input id="r_senha" type="password" class="input" style="width:100%; margin-top:6px">
      </label>
      <p id="r_erro" class="muted" style="color:#dc2626; margin-top:8px"></p>
      <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:10px">
        <button class="btn-secondary btn" value="cancel">Cancelar</button>
        <button id="r_salvar" type="button" class="btn">Salvar</button>
      </div>
    </form>
  </dialog>

  <!-- Modal Permiss√µes (original, mantido) -->
  <dialog id="dlgPerm" style="border:0; border-radius:12px; padding:0; width:95%; max-width:620px;">
    <form method="dialog" style="padding:18px" id="formPerm">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
        <h3 style="margin:0">Gerenciar permiss√µes</h3>
        <button class="btn-secondary btn" value="cancel">Fechar</button>
      </div>

      <label>Usu√°rio
        <select id="perm_sel_user" class="input" style="width:100%; margin-top:6px">
          <option value="">Selecione um usu√°rio‚Ä¶</option>
        </select>
      </label>
      <p class="muted" id="perm_hint" style="margin:6px 0 0; display:none;">
        Se o usu√°rio n√£o aparecer, ele ainda n√£o fez login no sistema.
      </p>

      <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:10px; margin-top:14px;">
        <label class="input" style="display:flex; align-items:center; gap:10px;">
          <input id="perm_admin" type="checkbox"> Administrador
        </label>
        <label class="input" style="display:flex; align-items:center; gap:10px;">
          <input id="perm_controle" type="checkbox"> Controle Di√°rio
        </label>
        <label class="input" style="display:flex; align-items:center; gap:10px;">
          <input id="perm_consumo" type="checkbox"> Consumo Total
        </label>
      </div>

      <p id="perm_msg" class="muted" style="margin:10px 0 0;"></p>

      <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:14px">
        <button class="btn-secondary btn" value="cancel">Cancelar</button>
        <button id="perm_salvar" type="button" class="btn">Salvar</button>
      </div>
    </form>
  </dialog>

  <!-- Script principal (seu original) -->
  <script type="module">
    import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js';

    // === CONFIG ===
    const SUPABASE_URL = 'https://ilsbyrvnrkutwynujfhs.supabase.co';
    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlsc2J5cnZucmt1dHd5bnVqZmhzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzNDAwNDEsImV4cCI6MjA2OTkxNjA0MX0.o56R-bf1Nt3PiqMZbG_ghEPYZzrPnEU-jCdYKkjylTQ';

    // URLs das Edge Functions:
    const CREATE_URL = 'https://ilsbyrvnrkutwynujfhs.supabase.co/functions/v1/create-user';
    const RESET_URL  = 'https://ilsbyrvnrkutwynujfhs.supabase.co/functions/v1/reset-password';
    const LIST_URL   = 'https://ilsbyrvnrkutwynujfhs.supabase.co/functions/v1/list-users';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

    // === Sess√£o/boas-vindas ===
    const chipUser = document.getElementById('chipUser');
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) window.location.href = 'index.html';
    const emailLogado = session.user.email;
    try {
      const { data: ua } = await supabase.from('usuarios_app').select('display_name').ilike('email', emailLogado).maybeSingle();
      chipUser.textContent = 'Logado: ' + (ua?.display_name || emailLogado);
    } catch { chipUser.textContent = 'Logado: ' + emailLogado; }

    document.getElementById('btnSairMenu').onclick = () => window.location.href = 'menu.html';
    document.getElementById('btnLogout').onclick = async () => { await supabase.auth.signOut(); window.location.href = 'index.html'; };

    // === Modais cadastro/reset ===
    const dlgCreate = document.getElementById('dlgCreate');
    const dlgReset  = document.getElementById('dlgReset');
    document.getElementById('btnOpenCreate').onclick = () => dlgCreate.showModal();
    document.getElementById('btnOpenReset').onclick  = () => dlgReset.showModal();

    // === Mostrar/ocultar listagem ===
    const cardList = document.getElementById('cardList');
    document.getElementById('btnOpenList').onclick = async () => {
      cardList.style.display = '';
      await loadUsers(true);
      cardList.scrollIntoView({ behavior: 'smooth', block: 'start' });
    };
    document.getElementById('btnCloseList').onclick = () => {
      cardList.style.display = 'none';
    };

    // Criar usu√°rio
    document.getElementById('c_salvar').onclick = async () => {
      const nome  = document.getElementById('c_nome').value.trim();
      const user  = document.getElementById('c_user').value.trim();
      const email = document.getElementById('c_email').value.trim().toLowerCase();
      const pass  = document.getElementById('c_senha').value;
      const err   = document.getElementById('c_erro');
      err.textContent = '';
      if (!nome || !user || !email || !pass) { err.textContent = 'Preencha todos os campos.'; return; }
      const { data: { session } } = await supabase.auth.getSession();
      const resp = await fetch(CREATE_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${session.access_token}` },
        body: JSON.stringify({ email, password: pass, username: user, display_name: nome }),
      });
      const json = await resp.json();
      if (!resp.ok) { err.textContent = 'Erro: ' + (json.details || json.error || 'falha'); return; }
      dlgCreate.close();
      if (cardList.style.display !== 'none') await loadUsers(true);
    };

    // Reset de senha
    document.getElementById('r_salvar').onclick = async () => {
      const email = document.getElementById('r_email').value.trim().toLowerCase();
      const pass  = document.getElementById('r_senha').value;
      const err   = document.getElementById('r_erro');
      err.textContent = '';
      if (!email || !pass) { err.textContent = 'Informe e-mail e nova senha.'; return; }
      const { data: { session } } = await supabase.auth.getSession();
      const resp = await fetch(RESET_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${session.access_token}` },
        body: JSON.stringify({ email, newPassword: pass }),
      });
      const json = await resp.json();
      if (!resp.ok) { err.textContent = 'Erro: ' + (json.details || json.error || 'falha'); return; }
      dlgReset.close();
    };

    // === Lista de usu√°rios (Edge Function list-users) ===
    const tbody = document.getElementById('tbody');
    const busca = document.getElementById('busca');
    const perPageSel = document.getElementById('perPage');
    const btnPrev = document.getElementById('prev');
    const btnNext = document.getElementById('next');
    const pageInfo = document.getElementById('pageInfo');
    document.getElementById('btnRefresh').onclick = () => loadUsers(true);

    let state = {
      page: 1,
      perPage: parseInt(perPageSel.value, 10),
      sortBy: 'created_at',
      sortDir: 'desc',
      raw: [],
      hasMore: false,
    };

    perPageSel.onchange = () => { state.perPage = parseInt(perPageSel.value, 10); state.page = 1; loadUsers(true); };
    btnPrev.onclick = () => { if (state.page > 1) { state.page--; loadUsers(true); } };
    btnNext.onclick = () => { if (state.hasMore) { state.page++; loadUsers(true); } };

    document.querySelectorAll('th[data-sort]').forEach(th => {
      th.addEventListener('click', () => {
        const col = th.dataset.sort;
        if (state.sortBy === col) state.sortDir = state.sortDir === 'asc' ? 'desc' : 'asc';
        else { state.sortBy = col; state.sortDir = 'asc'; }
        render();
      });
    });

    const fmt = (d) => d ? new Date(d).toLocaleString('pt-BR') : '‚Äî';
    const nomeDe = (u) => u.display_name || u.username || (u.email?.split('@')[0]) || '(sem nome)';

    async function loadUsers() {
      const { data: { session } } = await supabase.auth.getSession();
      const url = new URL(LIST_URL);
      url.searchParams.set('page', String(state.page));
      url.searchParams.set('perPage', String(state.perPage));
      const resp = await fetch(url, { headers: { Authorization: `Bearer ${session.access_token}` } });
      const json = await resp.json();
      if (!resp.ok) { alert('Falha ao listar usu√°rios: ' + (json.error || json.details || '')); return; }
      state.raw = json.users || [];
      state.hasMore = !!json.hasMore;
      render();
    }

    function render() {
      const term = busca.value.trim().toLowerCase();
      let rows = state.raw.slice();
      if (term) {
        rows = rows.filter(u =>
          (nomeDe(u).toLowerCase().includes(term)) ||
          ((u.email||'').toLowerCase().includes(term))
        );
      }
      rows.sort((a,b) => {
        const k = state.sortBy;
        const va = (a[k] || '') + '';
        const vb = (b[k] || '') + '';
        if (va < vb) return state.sortDir === 'asc' ? -1 : 1;
        if (va > vb) return state.sortDir === 'asc' ? 1 : -1;
        return 0;
      });

      tbody.innerHTML = '';
      if (!rows.length) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 5; td.className = 'empty'; td.textContent = 'Nenhum usu√°rio nesta p√°gina.';
        tr.appendChild(td); tbody.appendChild(tr);
      } else {
        for (const u of rows) {
          const tr = document.createElement('tr');

          const tdNome = document.createElement('td'); tdNome.textContent = nomeDe(u); tr.appendChild(tdNome);
          const tdEmail = document.createElement('td'); tdEmail.textContent = u.email || '‚Äî'; tr.appendChild(tdEmail);
          const tdCriado = document.createElement('td'); tdCriado.textContent = fmt(u.created_at); tr.appendChild(tdCriado);
          const tdUlt = document.createElement('td'); tdUlt.textContent = fmt(u.last_sign_in_at); tr.appendChild(tdUlt);

          const tdA = document.createElement('td'); tdA.className = 'right';
          const del = document.createElement('button'); del.className = 'btn danger'; del.textContent = 'Excluir';
          del.onclick = () => excluir(u);
          tdA.appendChild(del); tr.appendChild(tdA);

          tbody.appendChild(tr);
        }
      }

      pageInfo.textContent = `P√°gina ${state.page} ‚Ä¢ ${rows.length} itens`;
      btnPrev.disabled = state.page === 1;
      btnNext.disabled = !state.hasMore;
    }

    busca.addEventListener('input', () => render());

    async function excluir(u) {
      if (!confirm(`Excluir o usu√°rio "${nomeDe(u)}" (${u.email})? Essa a√ß√£o n√£o pode ser desfeita.`)) return;
      const { data: { session } } = await supabase.auth.getSession();
      const resp = await fetch(LIST_URL, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${session.access_token}` },
        body: JSON.stringify({ id: u.id }),
      });
      const json = await resp.json();
      if (!resp.ok) { alert('Falha ao excluir: ' + (json.details || json.error || '')); return; }
      if (state.raw.length === 1 && state.page > 1) state.page--;
      await loadUsers(true);
    }

    // ======= (perm modal antigo segue igual) =======
    const btnOpenPerm = document.getElementById('btnOpenPerm');
    const dlgPerm = document.getElementById('dlgPerm');
    const selUser = document.getElementById('perm_sel_user');
    const chkAdmin = document.getElementById('perm_admin');
    const chkCtrl  = document.getElementById('perm_controle');
    const chkCons  = document.getElementById('perm_consumo');
    const msgPerm  = document.getElementById('perm_msg');
    const hintPerm = document.getElementById('perm_hint');
    const btnPermSalvar = document.getElementById('perm_salvar');

    function openDialog(el) {
      try { if (typeof el.showModal === 'function') el.showModal(); else el.setAttribute('open',''); }
      catch { el.setAttribute('open',''); }
    }
    function closeDialog(el) {
      try { if (typeof el.close === 'function') el.close(); else el.removeAttribute('open'); }
      catch { el.removeAttribute('open'); }
    }

    document.getElementById('formPerm')?.addEventListener('submit', e => {
      e.preventDefault(); closeDialog(dlgPerm);
    });
    dlgPerm?.addEventListener('cancel', (e) => {
      e.preventDefault(); closeDialog(dlgPerm);
    });

    // OBS: esse handler ser√° sobrescrito pelo modal novo (perm2) abaixo
    btnOpenPerm.onclick = async () => {
      openDialog(dlgPerm);
      setTimeout(() => selUser?.focus(), 0);
      await carregarUsuariosPerm();
    };

    document.addEventListener('keydown', (e) => {
      const modalAberto = dlgPerm?.hasAttribute('open');
      if (!modalAberto) return;

      if (e.key === 'Escape') {
        e.preventDefault();
        closeDialog(dlgPerm);
      } else if (e.key === 'Enter') {
        if (dlgPerm.contains(document.activeElement)) {
          e.preventDefault();
          btnPermSalvar?.click();
        }
      }
    });

    async function carregarUsuariosPerm() {
      msgPerm.textContent = 'Carregando usu√°rios‚Ä¶';
      selUser.innerHTML = '<option value="">Selecione um usu√°rio‚Ä¶</option>';
      hintPerm.style.display = 'none';

      const { data: { session } } = await supabase.auth.getSession();
      if (!session) { msgPerm.textContent = '√â necess√°rio estar logado.'; return; }

      const { data, error } = await supabase.rpc('list_users');
      if (error) { msgPerm.textContent = 'Erro ao listar usu√°rios: ' + (error.message || error); return; }
      if (!data || data.length === 0) {
        msgPerm.textContent = 'Nenhum usu√°rio encontrado.';
        hintPerm.style.display = 'block';
        return;
      }

      data.sort((a,b) => (a.email || '').localeCompare(b.email || ''));
      for (const u of data) {
        const opt = document.createElement('option');
        opt.value = u.user_id;
        const last = u.last_sign_in_at ? ` ‚Äî ${new Date(u.last_sign_in_at).toLocaleString('pt-BR')}` : '';
        opt.textContent = `${u.email}${last}`;
        selUser.appendChild(opt);
      }
      msgPerm.textContent = 'Selecione um usu√°rio e ajuste as permiss√µes.';
    }

    selUser.addEventListener('change', async (e) => {
      const id = e.target.value;
      chkAdmin.checked = false;
      chkCtrl.checked  = false;
      chkCons.checked  = false;
      if (!id) { msgPerm.textContent = ''; return; }

      msgPerm.textContent = 'Lendo permiss√µes‚Ä¶';
      const { data, error } = await supabase
        .from('permissoes_app')
        .select('is_admin, perm_controle_diario, perm_consumo_total')
        .eq('user_id', id)
        .maybeSingle();

      if (error) { msgPerm.textContent = 'Erro: ' + (error.message || error); return; }

      chkAdmin.checked = !!data?.is_admin;
      chkCtrl.checked  = !!data?.perm_controle_diario;
      chkCons.checked  = !!data?.perm_consumo_total;
      msgPerm.textContent = data ? 'Permiss√µes carregadas.' : 'Usu√°rio ainda sem registro; ao salvar ser√° criado.';
    });

    btnPermSalvar.onclick = async () => {
      const id = selUser.value;
      if (!id) { msgPerm.textContent = 'Selecione um usu√°rio.'; return; }

      msgPerm.textContent = 'Salvando‚Ä¶';
      const { error } = await supabase.rpc('set_permissoes', {
        p_user_id: id,
        p_perm_controle: chkCtrl.checked,
        p_perm_consumo: chkCons.checked,
        p_is_admin: chkAdmin.checked
      });

      if (error) { msgPerm.textContent = 'Erro ao salvar: ' + (error.message || error); return; }
      msgPerm.textContent = 'Permiss√µes salvas com sucesso.';
      closeDialog(dlgPerm);
    };
  </script>

  <!-- =================== ADDON N√ÉO-DESTRUTIVO (igual ao seu) =================== -->
  <script type="module" id="permissoes-addon">
    if (!window.__permissoes_addon_init__) {
      window.__permissoes_addon_init__ = true;

      const alreadyHas = document.getElementById('btnOpenPerm') && document.getElementById('dlgPerm');
      if (!alreadyHas) {
        if (!document.getElementById('dlg-perm-style')) {
          const st = document.createElement('style');
          st.id = 'dlg-perm-style';
          st.textContent = `dialog::backdrop{background:rgba(0,0,0,.45);} dialog[open]{display:block;}`;
          document.head.appendChild(st);
        }

        (function ensurePermButton(){
          if (document.getElementById('btnOpenPerm')) return;
          const toolbar = document.querySelector('.toolbar');
          if (!toolbar) return;
          const btn = document.createElement('button');
          btn.className = 'btn';
          btn.id = 'btnOpenPerm';
          btn.textContent = 'üõ°Ô∏è Permiss√µes';
          const muted = toolbar.querySelector('.muted');
          toolbar.insertBefore(btn, muted || null);
        })();

        (function ensurePermModal(){
          if (document.getElementById('dlgPerm')) return;
          const dlg = document.createElement('dialog');
          dlg.id = 'dlgPerm';
          dlg.style.cssText = 'border:0; border-radius:12px; padding:0; width:95%; max-width:620px;';
          dlg.innerHTML = `
            <form method="dialog" style="padding:18px" id="formPerm">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
                <h3 style="margin:0">Gerenciar permiss√µes</h3>
                <button class="btn-secondary btn" value="cancel">Fechar</button>
              </div>
              <label>Usu√°rio
                <select id="perm_sel_user" class="input" style="width:100%; margin-top:6px">
                  <option value="">Selecione um usu√°rio‚Ä¶</option>
                </select>
              </label>
              <p class="muted" id="perm_hint" style="margin:6px 0 0; display:none;">Se o usu√°rio n√£o aparecer, ele ainda n√£o fez login no sistema.</p>
              <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:10px; margin-top:14px;">
                <label class="input" style="display:flex; align-items:center; gap:10px;">
                  <input id="perm_admin" type="checkbox"> Administrador
                </label>
                <label class="input" style="display:flex; align-items:center; gap:10px;">
                  <input id="perm_controle" type="checkbox"> Controle Di√°rio
                </label>
                <label class="input" style="display:flex; align-items:center; gap:10px;">
                  <input id="perm_consumo" type="checkbox"> Consumo Total
                </label>
              </div>
              <p id="perm_msg" class="muted" style="margin:10px 0 0;"></p>
              <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:14px">
                <button class="btn-secondary btn" value="cancel">Cancelar</button>
                <button id="perm_salvar" type="button" class="btn">Salvar</button>
              </div>
            </form>`;
          document.body.appendChild(dlg);
        })();
      }
    }
  </script>

  <!-- ========= NOVO MODAL PERMISS√ïES (UI melhor) + LISTA via list-users ========= -->
  <style id="perm2-style">
    .perm2-dialog{border:0;border-radius:16px;padding:0;width:95%;max-width:860px;}
    .perm2-wrap{display:grid;grid-template-columns:340px 1fr;gap:0;min-height:480px}
    @media(max-width:900px){.perm2-wrap{grid-template-columns:1fr;min-height:0}}
    .perm2-col{padding:16px}
    .perm2-left{border-right:1px solid #eef2f7;background:#fbfdff}
    .perm2-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .perm2-title{margin:0;font-size:18px;color:#0f172a}
    .perm2-close{background:#6b7280;color:#fff;border:0;border-radius:8px;padding:8px 10px;cursor:pointer}
    .perm2-input{width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:10px;background:#fff}
    .perm2-list{margin-top:10px;border:1px solid #eef2f7;border-radius:12px;max-height:380px;overflow:auto;background:#fff}
    .perm2-item{display:flex;gap:10px;align-items:center;padding:10px 12px;border-bottom:1px solid #f3f4f6;cursor:pointer}
    .perm2-item:hover{background:#f8fafc}
    .perm2-item.active{background:#e8f0ff}
    .perm2-avatar{width:30px;height:30px;border-radius:999px;background:#e5e7eb;display:flex;align-items:center;justify-content:center;font-weight:800;color:#334155}
    .perm2-name{font-weight:700;color:#0f172a}
    .perm2-email{font-size:12px;color:#6b7280}
    .perm2-right h4{margin:0 0 10px}
    .perm2-role{display:flex;flex-direction:column;gap:12px;margin-top:8px}
    .perm2-check{display:flex;align-items:center;gap:10px;border:1px solid #e5e7eb;border-radius:12px;padding:12px;background:#fff}
    .perm2-badges{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .perm2-badge{font-size:12px;background:#eef2ff;color:#1e3a8a;padding:4px 8px;border-radius:999px}
    .perm2-footer{display:flex;justify-content:flex-end;gap:8px;margin-top:16px}
    .perm2-btn{background:#0ea5b7;color:#fff;border:0;border-radius:10px;padding:10px 14px;cursor:pointer}
    .perm2-btn:hover{background:#12849a}
    .perm2-btn-sec{background:#6b7280}
    .perm2-btn-sec:hover{background:#4b5563}
    .perm2-msg{color:#6b7280;font-size:13px;margin-top:8px;min-height:18px}
    dialog#dlgPerm2::backdrop { background: rgba(0,0,0,.45); }
    dialog[open]{display:block}
  </style>

  <dialog id="dlgPerm2" class="perm2-dialog">
    <div class="perm2-wrap" role="dialog" aria-labelledby="perm2-title">
      <div class="perm2-col perm2-left">
        <div class="perm2-head">
          <h3 id="perm2-title" class="perm2-title">Permiss√µes</h3>
          <button type="button" class="perm2-close" id="perm2-close">Fechar</button>
        </div>
        <input id="perm2-search" class="perm2-input" placeholder="Buscar por nome ou e-mail‚Ä¶">
        <div id="perm2-list" class="perm2-list" role="listbox" aria-label="Usu√°rios"></div>
      </div>

      <div class="perm2-col perm2-right">
        <h4 id="perm2-userTitle" style="margin-top:2px">Selecione um usu√°rio</h4>
        <div class="perm2-badges" id="perm2-userBadges"></div>

        <div class="perm2-role" aria-label="Definir papel">
          <label class="perm2-check">
            <input type="checkbox" id="perm2-admin">
            <div>
              <div style="font-weight:700">Administrador</div>
              <div style="font-size:12px;color:#6b7280">Acesso total ao sistema.</div>
            </div>
          </label>

          <label class="perm2-check">
            <input type="checkbox" id="perm2-user">
            <div>
              <div style="font-weight:700">Usu√°rio</div>
              <div style="font-size:12px;color:#6b7280">Sem privil√©gios administrativos.</div>
            </div>
          </label>
        </div>

        <div class="perm2-msg" id="perm2-msg"></div>

        <div class="perm2-footer">
          <button type="button" class="perm2-btn perm2-btn-sec" id="perm2-cancel">Cancelar</button>
          <button type="button" class="perm2-btn" id="perm2-save">Salvar</button>
        </div>
      </div>
    </div>
  </dialog>

  <script type="module" id="perm2-script">
    import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js';

    const SUPABASE_URL  = 'https://ilsbyrvnrkutwynujfhs.supabase.co';
    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlsc2J5cnZucmt1dHd5bnVqZmhzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzNDAwNDEsImV4cCI6MjA2OTkxNjA0MX0.o56R-bf1Nt3PiqMZbG_ghEPYZzrPnEU-jCdYKkjylTQ';
    const LIST_URL   = 'https://ilsbyrvnrkutwynujfhs.supabase.co/functions/v1/list-users';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

    const dlg     = document.getElementById('dlgPerm2');
    const btnOpen = document.getElementById('btnOpenPerm');
    const btnClose= document.getElementById('perm2-close');
    const btnCancel = document.getElementById('perm2-cancel');
    const btnSave = document.getElementById('perm2-save');
    const listEl  = document.getElementById('perm2-list');
    const search  = document.getElementById('perm2-search');
    const chkAdm  = document.getElementById('perm2-admin');
    const chkUser = document.getElementById('perm2-user');
    const msg     = document.getElementById('perm2-msg');
    const title   = document.getElementById('perm2-userTitle');
    const badges  = document.getElementById('perm2-userBadges');

    let users = [];
    let filtered = [];
    let selected = null;

    function openDialog(){ try{ dlg.showModal(); } catch{ dlg.setAttribute('open',''); } }
    function closeDialog(){ try{ dlg.close(); } catch{ dlg.removeAttribute('open'); } }

    chkAdm.addEventListener('change', () => { if (chkAdm.checked) chkUser.checked = false; else chkUser.checked = true; });
    chkUser.addEventListener('change', () => { if (chkUser.checked) chkAdm.checked = false; else chkAdm.checked = true; });

    function userRow(u, active) {
      const div = document.createElement('div');
      div.className = 'perm2-item' + (active ? ' active' : '');
      div.setAttribute('role', 'option');
      div.dataset.uid = u.id || u.user_id;

      const initials = (u.display_name || u.username || (u.email||'').split('@')[0] || '?')
        .split(/\s+/).map(p=>p[0]).join('').slice(0,2).toUpperCase();

      div.innerHTML = `
        <div class="perm2-avatar">${initials || '?'}</div>
        <div>
          <div class="perm2-name">${u.display_name || u.username || (u.email||'').split('@')[0] || '(sem nome)'}</div>
          <div class="perm2-email">${u.email || ''}</div>
        </div>
      `;
      div.onclick = () => selectUser(u.id || u.user_id);
      return div;
    }

    function renderList() {
      listEl.innerHTML = '';
      for (const u of filtered) listEl.appendChild(userRow(u, (selected?.user_id || selected?.id) === (u.id || u.user_id)));
    }

    function applyFilter(term) {
      const t = (term||'').trim().toLowerCase();
      if (!t) filtered = users.slice();
      else {
        filtered = users.filter(u =>
          (u.display_name||'').toLowerCase().includes(t) ||
          (u.username||'').toLowerCase().includes(t) ||
          (u.email||'').toLowerCase().includes(t)
        );
      }
      renderList();
    }

    async function loadUsers() {
      msg.textContent = 'Carregando usu√°rios‚Ä¶';
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) { msg.textContent = 'Sess√£o expirada.'; return; }

      // Usa a Edge Function list-users (service role) para listar sem esbarrar em RLS
      const url = new URL(LIST_URL);
      url.searchParams.set('page','1');
      url.searchParams.set('perPage','1000');
      const resp = await fetch(url, { headers: { Authorization: `Bearer ${session.access_token}` }});
      const json = await resp.json().catch(()=> ({}));

      if (!resp.ok) {
        msg.textContent = 'Erro ao carregar: ' + (json.error || json.details || resp.statusText);
        users = []; filtered = []; renderList();
        return;
      }

      // Normaliza (id -> user_id p/ evitar confus√£o)
      users = (json.users || []).map(u => ({
        user_id: u.id,
        email: u.email,
        display_name: u.display_name || '',
        username: u.username || ''
      }));
      filtered = users.slice();
      renderList();
      msg.textContent = users.length ? 'Selecione um usu√°rio na lista.' : 'Nenhum usu√°rio cadastrado.';
    }

    async function selectUser(user_id) {
      selected = users.find(u => (u.user_id || u.id) === user_id) || null;
      document.querySelectorAll('.perm2-item').forEach(i => i.classList.toggle('active', (i.dataset.uid) === String(user_id)));

      if (!selected) {
        title.textContent = 'Selecione um usu√°rio';
        chkAdm.checked = false; chkUser.checked = true;
        badges.innerHTML = '';
        msg.textContent = '';
        return;
      }

      title.textContent = (selected.display_name || selected.username || selected.email || 'Usu√°rio') + ' ‚Äî papel';
      badges.innerHTML = '';
      if (selected.username) {
        const b = document.createElement('span'); b.className='perm2-badge'; b.textContent='@' + selected.username; badges.appendChild(b);
      }
      if (selected.email) {
        const b = document.createElement('span'); b.className='perm2-badge'; b.textContent=selected.email; badges.appendChild(b);
      }

      msg.textContent = 'Lendo permiss√µes‚Ä¶';
      const { data, error } = await supabase
        .from('permissoes_app')
        .select('is_admin')
        .eq('user_id', user_id)
        .maybeSingle();

      if (error) { msg.textContent = 'Erro: ' + (error.message || error); return; }

      const isAdmin = !!data?.is_admin;
      chkAdm.checked = isAdmin;
      chkUser.checked = !isAdmin;
      msg.textContent = data ? 'Permiss√µes carregadas.' : 'Usu√°rio sem registro em permissoes_app; ser√° criado ao salvar.';
    }

    async function saveRole() {
      if (!selected) { msg.textContent = 'Selecione um usu√°rio.'; return; }
      msg.textContent = 'Salvando‚Ä¶';

      const { error } = await supabase.rpc('set_permissoes', {
        p_user_id: selected.user_id,
        p_perm_controle: false,
        p_perm_consumo: false,
        p_is_admin: chkAdm.checked
      });

      if (error) { msg.textContent = 'Erro ao salvar: ' + (error.message || error); return; }
      msg.textContent = 'Permiss√µes salvas com sucesso.';
      setTimeout(() => { try{ dlg.close(); } catch{ dlg.removeAttribute('open'); } }, 300);
    }

    // Abre o modal novo (sobrescreve o onclick antigo)
    btnOpen?.addEventListener('click', async () => {
      openDialog();
      search.value = '';
      selected = null;
      chkAdm.checked = false;
      chkUser.checked = true;
      title.textContent = 'Selecione um usu√°rio';
      badges.innerHTML = '';
      await loadUsers();
      setTimeout(() => search.focus(), 0);
    });

    btnClose.addEventListener('click', closeDialog);
    btnCancel.addEventListener('click', closeDialog);
    search.addEventListener('input', (e) => applyFilter(e.target.value));
    btnSave.addEventListener('click', saveRole);

    document.addEventListener('keydown', (e) => {
      const aberto = dlg.hasAttribute('open');
      if (!aberto) return;
      if (e.key === 'Escape') { e.preventDefault(); closeDialog(); }
      else if (e.key === 'Enter') {
        const right = document.querySelector('.perm2-right');
        if (right && right.contains(document.activeElement)) {
          e.preventDefault(); saveRole();
        }
      }
    });
  </script>
  <!-- ========= /NOVO MODAL ========= -->

</body>
</html>
