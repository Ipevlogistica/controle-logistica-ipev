-- =========================================================
-- USUÁRIOS DO APP (lookup de username → e-mail)
--  - Não altera outras tabelas/policies
--  - Não apaga dados
--  - Idempotente
-- =========================================================

-- 1) Tabela e chaves (se não existir)
create table if not exists public.usuarios_app (
  id uuid primary key references auth.users(id) on delete cascade,
  username text not null,
  email    text not null,
  display_name text,
  created_at timestamptz default now()
);

-- Índices de unicidade (case-insensitive)
create unique index if not exists usuarios_app_username_unique_idx
  on public.usuarios_app (lower(username));

create unique index if not exists usuarios_app_email_unique_idx
  on public.usuarios_app (lower(email));

-- 2) Habilita RLS (se já não estiver)
alter table public.usuarios_app enable row level security;

-- 3) Policy mínima para permitir lookup por username ANTES do login
--    (necessária para o seu index.html atual que consulta a tabela direto)
do $$
begin
  if not exists (
    select 1 from pg_policies
    where schemaname='public'
      and tablename='usuarios_app'
      and policyname='ua_select_anon_lookup'
  ) then
    create policy ua_select_anon_lookup
      on public.usuarios_app
      for select
      to anon
      using (true);
  end if;
end $$;

-- 4) Liga o username "Guilherme" ao e-mail do usuário que você criou no Auth
do $$
declare
  v_email text := lower('contato.ipev@gmail.com');
  v_id uuid;
begin
  -- pega o id no Auth
  select id into v_id
  from auth.users
  where lower(email) = v_email
  limit 1;

  if v_id is null then
    raise exception 'Usuário do Auth não encontrado para %', v_email;
  end if;

  -- insere/atualiza o vínculo (sem apagar nada)
  insert into public.usuarios_app (id, username, email, display_name)
  values (v_id, 'Guilherme', v_email, 'Administrador')
  on conflict (id) do update
    set username='Guilherme',
        email=excluded.email,
        display_name = coalesce(public.usuarios_app.display_name, excluded.display_name);
end $$;

-- (Opcional) Verificação rápida:
-- select id, username, email from public.usuarios_app where lower(username)='guilherme';
-- select id, email, email_confirmed_at from auth.users where lower(email)=lower('contato.ipev@gmail.com');
